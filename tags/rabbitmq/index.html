<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>标签: rabbitmq - Hexo</title>


    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/tags/rabbitmq/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta property="article:author" content="ouYang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/idea.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="Hexo" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">类别</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-9-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">标签</a></li>
            <li class="is-active"><a href="#" aria-current="page">rabbitmq</a></li>
        </ul>
        </nav>
    </div>
</div>

    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-01-18T08:15:34.000Z">2020-01-18</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/rabbitmq/">rabbitmq</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7100 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2020/01/18/RabbitMQ/">RabbitMQ</a>
            
        </h1>
        <div class="content">
            <a id="more"></a>

<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><p><img src="RabbitMQ/RabbitMQ.png" alt=""></p>
<h3 id="2-收发信息的步骤"><a href="#2-收发信息的步骤" class="headerlink" title="2.收发信息的步骤"></a>2.收发信息的步骤</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">生产者：</span><br><span class="line"><span class="number">1</span>.创建连接工厂</span><br><span class="line">ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">需要设置参数：</span><br><span class="line">	.setHost(String);</span><br><span class="line">	.setPort(<span class="keyword">int</span>);</span><br><span class="line">	.setUsername(String);</span><br><span class="line">	.setPassword(String);</span><br><span class="line">	.setVirtualHost(String);</span><br><span class="line"><span class="number">2</span>.通过工厂对象创建连接</span><br><span class="line">Connection connection = factory.newConnection();</span><br><span class="line"><span class="number">3</span>.通过连接对象创建通道</span><br><span class="line">Channel channel = connection.createChannel();</span><br><span class="line">	<span class="number">3.1</span>队列声明</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 声明队列，如果rabbit中没有此队列将自动创建</span></span><br><span class="line"><span class="comment">             * param1: 队列名称</span></span><br><span class="line"><span class="comment">             * param2: 是否持久化</span></span><br><span class="line"><span class="comment">             * param3: 队列是否独占此连接</span></span><br><span class="line"><span class="comment">             * param4: 队列不再使用时是否自动删除此队列</span></span><br><span class="line"><span class="comment">             * param5: 队列参数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">		.queueDeclare(String,<span class="keyword">boolean</span>,<span class="keyword">boolean</span>,<span class="keyword">boolean</span>,Map);</span><br><span class="line">	<span class="number">3.2</span>消息发布</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 消息发布方法</span></span><br><span class="line"><span class="comment">             * param1: Exchange的名称，如果没有指定名称，则使用 Default Exchange</span></span><br><span class="line"><span class="comment">             * param2: routingKey，消息的路由Key，用于Exchange（交换机）将消息转发到指定的消息队列</span></span><br><span class="line"><span class="comment">             * param3: 消息包含的属性</span></span><br><span class="line"><span class="comment">             * param4: 消息体</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 这里没有指定交换机，消息将发送给默认的交换机，每个队列也会绑定那个默认的交换机，</span></span><br><span class="line"><span class="comment">			*	但是不能</span></span><br><span class="line"><span class="comment">             * 绑定显示或是解除绑定</span></span><br><span class="line"><span class="comment">             * 默认的交换机，routingKey等于队列名称</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">		.basicPublish(<span class="string">""</span>,QUEUE,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">消费者：</span><br><span class="line"><span class="number">1</span>.创建连接工厂</span><br><span class="line">ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">		<span class="comment">//设置RabbitMQ所在服务器的ip和端口</span></span><br><span class="line">        factory.setHost(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line"><span class="number">2</span>.通过工厂对象创建连接</span><br><span class="line">Connection connection = factory.newConnection();</span><br><span class="line"><span class="number">3</span>.通过连接对象创建通道</span><br><span class="line">Channel channel = connection.createChannel();</span><br><span class="line">	<span class="number">3.1</span>队列声明</span><br><span class="line">	<span class="number">3.2</span>创建消费方法</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消费者接受消息调用此方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> consumerTag 消费者的标签，在channel.basicConsume()去指定</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> envelope    消息包的内容，可以从中获取消息id，消息的routingKey，交换机，消息</span></span><br><span class="line"><span class="comment">         *                      和重传标志（收到消息失败后是否需要重新发送）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> body</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultComsumer(channel)&#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			handleDelivery();</span><br><span class="line">        &#125;;</span><br><span class="line">	<span class="number">3.3</span>进行监听</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 监听消息String queue，boolean autoAck，Consumer callback</span></span><br><span class="line"><span class="comment">         * 参数明细：</span></span><br><span class="line"><span class="comment">         * 1.队列名称</span></span><br><span class="line"><span class="comment">         * 2.是否自动回复，设置为true表示消息接收到自动向mq回复接收到了，</span></span><br><span class="line"><span class="comment">         *      mq接收到回复消息会删除消息，</span></span><br><span class="line"><span class="comment">         *      设置为false则需要手动回复</span></span><br><span class="line"><span class="comment">         * 3.消费消息的方法，消费者接收到消息后调用此方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicConsume(QUEUE,<span class="keyword">true</span>,consumer);</span><br></pre></td></tr></table></figure>

<h4 id="1、发送端操作流程"><a href="#1、发送端操作流程" class="headerlink" title="1、发送端操作流程"></a>1、发送端操作流程</h4><ul>
<li>1）创建连接</li>
<li>2）创建通道</li>
<li>3）声明队列</li>
<li>4）发送消息</li>
</ul>
<h4 id="2、接收端"><a href="#2、接收端" class="headerlink" title="2、接收端"></a>2、接收端</h4><ul>
<li>1）创建连接</li>
<li>2）创建通道</li>
<li>3）声明队列</li>
<li>4）监听队列</li>
<li>5）接收消息</li>
<li>6）ack回复</li>
</ul>
<h3 id="3-简单队列"><a href="#3-简单队列" class="headerlink" title="3.简单队列"></a>3.简单队列</h3><h4 id="1-模型"><a href="#1-模型" class="headerlink" title="1.模型"></a>1.模型</h4><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p><img src="RabbitMQ/1.png" alt=""></p>
<h4 id="2-获取连接的工具类"><a href="#2-获取连接的工具类" class="headerlink" title="2.获取连接的工具类"></a>2.获取连接的工具类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务器地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务器端口 AMQP</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer PORT = <span class="number">5672</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME = <span class="string">"guest"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = <span class="string">"guest"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主机访问地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VIRTUALHOST = <span class="string">"/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(HOST);</span><br><span class="line">        factory.setPort(PORT);</span><br><span class="line">        factory.setUsername(USERNAME);</span><br><span class="line">        factory.setPassword(PASSWORD);</span><br><span class="line">        factory.setVirtualHost(VIRTUALHOST);</span><br><span class="line"></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-生产者生产消息"><a href="#3-生产者生产消息" class="headerlink" title="3.生产者生产消息"></a>3.生产者生产消息</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer01</span> </span>&#123;</span><br><span class="line">    <span class="comment">//对列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE = <span class="string">"helloworld"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        Channel channel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">            factory.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">            factory.setPort(<span class="number">5672</span>);</span><br><span class="line">            factory.setUsername(<span class="string">"guest"</span>);</span><br><span class="line">            factory.setPassword(<span class="string">"guest"</span>);</span><br><span class="line">            <span class="comment">//rabbitmq 默认虚拟机名称为"/"，虚拟机相当于一个独立的mq服务器</span></span><br><span class="line">            factory.setVirtualHost(<span class="string">"/"</span>);</span><br><span class="line">            <span class="comment">//创建与RabbitMQ服务的TCP连接</span></span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">            <span class="comment">//创建与Exchange的通道，每个连接可以创建多个通道，每一个通道代表一个会话任务。</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 声明队列，如果rabbit中没有此队列将自动创建</span></span><br><span class="line"><span class="comment">             * param1: 队列名称</span></span><br><span class="line"><span class="comment">             * param2: 是否持久化</span></span><br><span class="line"><span class="comment">             * param3: 队列是否独占此连接</span></span><br><span class="line"><span class="comment">             * param4: 队列不再使用时是否自动删除此队列</span></span><br><span class="line"><span class="comment">             * param5: 队列参数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.queueDeclare(QUEUE,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">            String message = <span class="string">"helloworld小明："</span>+System.currentTimeMillis();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 消息发布方法</span></span><br><span class="line"><span class="comment">             * param1: Exchange的名称，如果没有指定名称，则使用 Default Exchange</span></span><br><span class="line"><span class="comment">             * param2: routingKey，消息的路由Key，用于Exchange（交换机）将消息转发到指定的消息队列</span></span><br><span class="line"><span class="comment">             * param3: 消息包含的属性</span></span><br><span class="line"><span class="comment">             * param4: 消息体</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 这里没有指定交换机，消息将发送给默认的交换机，每个队列也会绑定那个默认的交换机，</span></span><br><span class="line"><span class="comment">             *	但是不能</span></span><br><span class="line"><span class="comment">             * 绑定显示或是解除绑定</span></span><br><span class="line"><span class="comment">             * 默认的交换机，routingKey等于队列名称</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicPublish(<span class="string">""</span>,QUEUE,<span class="keyword">null</span>,</span><br><span class="line">                    message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">"Send Message is："</span>+message);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="keyword">null</span>)&#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>)&#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-消费者消费消息"><a href="#4-消费者消费消息" class="headerlink" title="4.消费者消费消息"></a>4.消费者消费消息</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer01</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE = <span class="string">"helloworld"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        <span class="comment">//设置RabbitMQ所在服务器的ip和端口</span></span><br><span class="line">        factory.setHost(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//定义消费方法</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 消费者接受消息调用此方法</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> consumerTag 消费者的标签，在channel.basicConsume()去指定</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> envelope    消息包的内容，可以从中获取消息id，消息的routingKey，交换机，消息</span></span><br><span class="line"><span class="comment">             *                      和重传标志（收到消息失败后是否需要重新发送）</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> body</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">//交换机</span></span><br><span class="line">                String exchange = envelope.getExchange();</span><br><span class="line">                <span class="comment">//路由key</span></span><br><span class="line">                String routingKey = envelope.getRoutingKey();</span><br><span class="line">                <span class="comment">//消息id</span></span><br><span class="line">                <span class="keyword">long</span> deliveryTag = envelope.getDeliveryTag();</span><br><span class="line">                <span class="comment">//消息内容</span></span><br><span class="line">                String message = <span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>);</span><br><span class="line">                <span class="comment">//是否重传</span></span><br><span class="line">                <span class="keyword">boolean</span> isRedeliver = envelope.isRedeliver();</span><br><span class="line">                System.out.println(<span class="string">"exchange:"</span>+exchange);</span><br><span class="line">                System.out.println(<span class="string">"routingKey:"</span>+routingKey);</span><br><span class="line">                System.out.println(<span class="string">"deliveryTag:"</span>+deliveryTag);</span><br><span class="line">                System.out.println(<span class="string">"isRedeliver:"</span>+isRedeliver);</span><br><span class="line">                System.out.println(<span class="string">"message:"</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 监听消息String queue，boolean autoAck，Consumer callback</span></span><br><span class="line"><span class="comment">         * 参数明细：</span></span><br><span class="line"><span class="comment">         * 1.队列名称</span></span><br><span class="line"><span class="comment">         * 2.是否自动回复，设置为true表示消息接收到自动向mq回复接收到了，</span></span><br><span class="line"><span class="comment">         *		mq接收到回复消息会删除消息，设置为false则需要手动回复</span></span><br><span class="line"><span class="comment">         * 3.消费消息的方法，消费者接收到消息后调用此方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicConsume(QUEUE,<span class="keyword">true</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-简单队列的不足"><a href="#5-简单队列的不足" class="headerlink" title="5.简单队列的不足"></a>5.简单队列的不足</h4><p>耦合性高，生产者一一对应消费者（如何我想要有多个消费者消费队列中消息，这时候就不行了），队列名变更，这时候得同事变更。</p>
<h3 id="4-work-queues-工作队列模式"><a href="#4-work-queues-工作队列模式" class="headerlink" title="4.work  queues 工作队列模式"></a>4.work  queues 工作队列模式</h3><h4 id="1-模型-1"><a href="#1-模型-1" class="headerlink" title="1.模型"></a>1.模型</h4><p><img src="RabbitMQ/python-two.png" alt=""></p>
<p> 为什么会出现工作队列</p>
<p>simple队列是一一对应的，而且实际开发，生产者发送消息是毫不费力的，而消费者一般是要跟业务相结合的，消费者接受到消息之后就需要处理，可能需要花费时间，这时候队列就会积压了很多消息</p>
<h4 id="2-生产者"><a href="#2-生产者" class="headerlink" title="2.生产者"></a>2.生产者</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *               |-- C1</span></span><br><span class="line"><span class="comment">     * p -- Queue -- |</span></span><br><span class="line"><span class="comment">     *               |-- C2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_work_queue"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//获取Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue(String queueName, Boolean durable, Boolean exclusive, Boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            String message = <span class="string">"MQ "</span>+i;</span><br><span class="line">            channel.basicPublish(<span class="string">""</span>,QUEUE_NAME,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">"send message: "</span>+message);</span><br><span class="line">            Thread.sleep(i*<span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-消费者1"><a href="#3-消费者1" class="headerlink" title="3.消费者1"></a>3.消费者1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_work_queue"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//获取Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="comment">//消息到达 触发方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"[1] get message :"</span>+ <span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>*<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"[1] over"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//监听消息String queue，boolean autoAck，Consumer callback</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME,autoAck,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-消费者2"><a href="#4-消费者2" class="headerlink" title="4.消费者2"></a>4.消费者2</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_work_queue"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//获取Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="comment">//消息到达 触发方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"[2] get message :"</span>+ <span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"[2] over"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//监听消息String queue，boolean autoAck，Consumer callback</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME,autoAck,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-现象"><a href="#5-现象" class="headerlink" title="5.现象"></a>5.现象</h4><p>消费者1和消费者2处理的消息是一样的。</p>
<p>消费者1：偶数</p>
<p>消费者2：奇数</p>
<p>这种方式叫做<strong>轮询分发</strong>（roun-robin）结果就是：不管谁忙活着谁清闲 都不会多给一个消息任务</p>
<p>任务消息总是平均分配。（你一个我一个）</p>
<h3 id="5-公平分发-fair-depatch"><a href="#5-公平分发-fair-depatch" class="headerlink" title="5.公平分发 fair depatch"></a>5.公平分发 fair depatch</h3><h4 id="1-说明"><a href="#1-说明" class="headerlink" title="1.说明"></a>1.说明</h4><p>使用公平分发，必须关闭自动应答ack,改为手动</p>
<h4 id="2-生产者-1"><a href="#2-生产者-1" class="headerlink" title="2.生产者"></a>2.生产者</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *               |-- C1</span></span><br><span class="line"><span class="comment">     * p -- Queue -- |</span></span><br><span class="line"><span class="comment">     *               |-- C2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_work_queue"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//获取Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue(String queueName, Boolean durable, Boolean exclusive, Boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 每个消费者 发送确认消息消息之前，消息队列不发送下一个消息到消费者，一次只处理一个消息</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 限制发送给同一个消费者不得超过一条消息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> prefetchCount = <span class="number">1</span>;</span><br><span class="line">        channel.basicQos(prefetchCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            String message = <span class="string">"MQ "</span>+i;</span><br><span class="line">            channel.basicPublish(<span class="string">""</span>,QUEUE_NAME,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">"send message: "</span>+message);</span><br><span class="line">            Thread.sleep(i*<span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-消费者1-1"><a href="#3-消费者1-1" class="headerlink" title="3.消费者1"></a>3.消费者1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_work_queue"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//获取Channel</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">int</span> prefetchCount = <span class="number">1</span>;</span><br><span class="line">        channel.basicQos(prefetchCount);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="comment">//消息到达 触发方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"[1] get message :"</span>+ <span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>*<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//手动回执应答</span></span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                    System.out.println(<span class="string">"[1] over"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;<span class="comment">//非自动应答</span></span><br><span class="line">        <span class="comment">//监听消息String queue，boolean autoAck，Consumer callback</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME,autoAck,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-消费者2-1"><a href="#4-消费者2-1" class="headerlink" title="4.消费者2"></a>4.消费者2</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_work_queue"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//获取Channel</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">int</span> prefetchCount = <span class="number">1</span>;</span><br><span class="line">        channel.basicQos(prefetchCount);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="comment">//消息到达 触发方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"[2] get message :"</span>+ <span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//手动回执应答</span></span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                    System.out.println(<span class="string">"[2] over"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//监听消息String queue，boolean autoAck，Consumer callback</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME,autoAck,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-与work-queues的差别之处"><a href="#5-与work-queues的差别之处" class="headerlink" title="5.与work queues的差别之处"></a>5.与work queues的差别之处</h4><h5 id="5-1-生产者"><a href="#5-1-生产者" class="headerlink" title="5.1 生产者"></a>5.1 生产者</h5><p><img src="RabbitMQ/workQueue&workFairs%E5%B7%AE%E5%88%AB0.png" alt=""></p>
<h5 id="5-2-消费者"><a href="#5-2-消费者" class="headerlink" title="5.2 消费者"></a>5.2 消费者</h5><p><img src="RabbitMQ/workQueue&workFairs%E5%B7%AE%E5%88%AB.png" alt=""></p>
<h4 id="6-现象"><a href="#6-现象" class="headerlink" title="6.现象"></a>6.现象</h4><p>消费者2处理的消息比消费者1多（能者多劳，公平分发）</p>
<p><img src="RabbitMQ/routing_key.png" alt="1544511437000"></p>
<h3 id="6-消息应答-与-消息持久化"><a href="#6-消息应答-与-消息持久化" class="headerlink" title="6.消息应答 与 消息持久化"></a>6.消息应答 与 消息持久化</h3><h4 id="6-1消息应答"><a href="#6-1消息应答" class="headerlink" title="6.1消息应答"></a>6.1消息应答</h4><p>自动确认模式：</p>
<p>​    RabbitMQ一旦将消息分发非消费之后，就会从内存中删除这个消息</p>
<p>现象：</p>
<p>​    这种情况下，如果杀死（kill）当前正在执行的消费者，就会丢失正在执行的消息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> autoAck = <span class="keyword">true</span>;<span class="comment">//自动应答</span></span><br><span class="line">channel.basicConsume(QUEUE_NAME,autoAck,consumer);</span><br></pre></td></tr></table></figure>



<p>手动确认模式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;<span class="comment">//非自动应答</span></span><br><span class="line"><span class="comment">//监听消息String queue，boolean autoAck，Consumer callback</span></span><br><span class="line">channel.basicConsume(QUEUE_NAME,autoAck,consumer);</span><br></pre></td></tr></table></figure>

<p>如果有一个消费者挂掉，就会交付给其他消费者。RabbitMQ支持消息应答，消费者发送一个消息应答，告诉RabbitMQ这个消息我已经处理完成，RabbitMQ可以将这个消息从<strong>内存</strong>中删除了。</p>
<p>(message acknowledgment)消息应答模式（Ack）是打开的， false。</p>
<p>如果RabbitMQ挂了，消息仍然会丢失。</p>
<h4 id="6-2消息持久化"><a href="#6-2消息持久化" class="headerlink" title="6.2消息持久化"></a>6.2消息持久化</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数：</span></span><br><span class="line"><span class="comment"> *  queue:队列的名称</span></span><br><span class="line"><span class="comment"> *  durable:能否持久化</span></span><br><span class="line"><span class="comment"> *  exclusive:是否独占连接</span></span><br><span class="line"><span class="comment"> *  autoDelete:是否自动删除</span></span><br><span class="line"><span class="comment"> *  arguments:参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line">channel.queueDeclare(QUEUE_NAME,durable,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<p>我们将程序中的boolean durable = true; 改为false是不可以的，会报错。尽管代码是正确的，但是该队列应该声明定义好了，就不可以再进行修改了。（RabbitMQ不允许用不同的参数重新定义一个已经存在的队列（可以先删除再创建））</p>
<h3 id="7-Exchange-交换机，转发器"><a href="#7-Exchange-交换机，转发器" class="headerlink" title="7.Exchange(交换机，转发器)"></a>7.Exchange(交换机，转发器)</h3><p>一方面是接收生产者的消息，另一方面是向队列推送消息。</p>
<p>匿名转发：“”;</p>
<h4 id="7-1-Fanout-Exchange-不处理路由键"><a href="#7-1-Fanout-Exchange-不处理路由键" class="headerlink" title="7.1 Fanout Exchange(不处理路由键)"></a>7.1 Fanout Exchange(不处理路由键)</h4><p><img src="RabbitMQ/fanout_exchange_1.png" alt=""></p>
<p>只需要将生产者与exchange进行bind，就会把exchange中的信息转发到与exchange绑定的所有Queue中。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">任何发送到Fanout Exchange的消息都会被转发到与该Exchange绑定(Binding)的所有Queue上。</span><br><span class="line"></span><br><span class="line">1.可以理解为路由表的模式</span><br><span class="line"></span><br><span class="line">2.这种模式不需要RouteKey</span><br><span class="line"></span><br><span class="line">3.这种模式需要提前将Exchange与Queue进行绑定，一个Exchange可以绑定多个Queue，一个Queue可以同多个Exchange进行绑定。</span><br><span class="line"></span><br><span class="line">4.如果接受到消息的Exchange没有与任何Queue绑定，则消息会被抛弃。</span><br></pre></td></tr></table></figure>



<h4 id="7-2-Direct-Exchange-处理路径键"><a href="#7-2-Direct-Exchange-处理路径键" class="headerlink" title="7.2 Direct Exchange     处理路径键"></a>7.2 Direct Exchange     处理路径键</h4><p><img src="RabbitMQ/direct_exchange.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">任何发送到Direct Exchange的消息都会被转发到RouteKey中指定的Queue。</span><br><span class="line"></span><br><span class="line">1.一般情况可以使用rabbitMQ自带的Exchange：”"(该Exchange的名字为空字符串，下文称其为default Exchange)。</span><br><span class="line"></span><br><span class="line">2.这种模式下不需要将Exchange进行任何绑定(binding)操作</span><br><span class="line"></span><br><span class="line">3.消息传递时需要一个“RouteKey”，可以简单的理解为要发送到的队列名字。</span><br><span class="line"></span><br><span class="line">4.如果vhost中不存在RouteKey中指定的队列名，则该消息会被抛弃。</span><br></pre></td></tr></table></figure>



<h4 id="7-3-Topic-Exchange"><a href="#7-3-Topic-Exchange" class="headerlink" title="7.3    Topic Exchange"></a>7.3    Topic Exchange</h4><p><img src="RabbitMQ/topic_exchange.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">任何发送到Topic Exchange的消息都会被转发到所有关心RouteKey中指定话题的Queue上</span><br><span class="line"></span><br><span class="line">1.这种模式较为复杂，简单来说，就是每个队列都有其关心的主题，所有的消息都带有一个“标题”(RouteKey)，Exchange会将消息转发到所有关注主题能与RouteKey模糊匹配的队列。</span><br><span class="line"></span><br><span class="line">2.这种模式需要RouteKey，也许要提前绑定Exchange与Queue。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.在进行绑定时，要提供一个该队列关心的主题，如“#.log.#”表示该队列关心所有涉及log的消息(一个RouteKey为”MQ.log.error”的消息会被转发到该队列)。</span><br><span class="line"></span><br><span class="line">4.“#”表示0个或若干个关键字，“*”表示一个关键字。如“log.*”能与“log.warn”匹配，无法与“log.warn.timeout”匹配；但是“log.#”能与上述两者匹配。</span><br><span class="line"></span><br><span class="line">5.同样，如果Exchange没有发现能够与RouteKey匹配的Queue，则会抛弃此消息。</span><br></pre></td></tr></table></figure>






<p><strong>性能排序：fanout &gt; direct &gt;&gt; topic。比例大约为11：10：6</strong></p>
<h3 id="8-订阅模式Publish-Subscribe-fanout"><a href="#8-订阅模式Publish-Subscribe-fanout" class="headerlink" title="8.订阅模式Publish/Subscribe(fanout)"></a>8.订阅模式Publish/Subscribe(fanout)</h3><h4 id="1-模型-2"><a href="#1-模型-2" class="headerlink" title="1.模型"></a>1.模型</h4><p><img src="RabbitMQ/python-three.png" alt=""></p>
<h4 id="2-解读"><a href="#2-解读" class="headerlink" title="2.解读"></a>2.解读</h4><ol>
<li>一个生产者，多个消费者。</li>
<li>每一个消费者都有自己对应的队列。</li>
<li>生产者没有直接把消息发送到队列 而是发送到了交换机 （转发器exchange）</li>
<li>每个队列都要绑定到交换机上</li>
<li>生产者发送的消息经过交换机到达队列 ，就能实现一个消息就可以被多个消费者消费。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">发布订阅模式：</span><br><span class="line">1、每个消费者监听自己的队列。</span><br><span class="line">2、生产者将消息发给broker，由交换机将消息转发到绑定此交换机的每个队列，每个绑定交换机的队列都将接收</span><br><span class="line">到消息</span><br></pre></td></tr></table></figure>



<p>注册 –&gt; 邮件 –&gt; 短信</p>
<h4 id="3-发送者"><a href="#3-发送者" class="headerlink" title="3.发送者"></a>3.发送者</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_fanout"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_fanout"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//通过工具类获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 声明交换机</span></span><br><span class="line"><span class="comment">         * 参数：</span></span><br><span class="line"><span class="comment">         * exchange:exchange的名字</span></span><br><span class="line"><span class="comment">         * type:exchange的类型</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">"fanout"</span>);<span class="comment">//分发</span></span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        String message = <span class="string">"hello publish/subscribe"</span>;</span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME,<span class="string">""</span>,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"send message : "</span>+message);</span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-exchange图示"><a href="#4-exchange图示" class="headerlink" title="4.exchange图示"></a>4.exchange图示</h4><p><img src="RabbitMQ/fanout_exchange.png" alt=""></p>
<p><strong>消息去哪里了？？</strong>丢失了，因为交换机没有存储的能力，在RabbitMQ里面只有队列有存储能力。因为此时没有把交换机和相应的队列进行绑定，所以数据就丢失了。</p>
<h4 id="5-发送者"><a href="#5-发送者" class="headerlink" title="5.发送者"></a>5.发送者</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_fanout"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过工具类获取连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明交换机</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数：</span></span><br><span class="line"><span class="comment">         * exchange:exchange的名字</span></span><br><span class="line"><span class="comment">         * type:exchange的类型</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">"fanout"</span>);<span class="comment">//分发</span></span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        String message = <span class="string">"hello publish/subscribe"</span>;</span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME,<span class="string">""</span>,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"send message : "</span>+message);</span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-消费者1"><a href="#6-消费者1" class="headerlink" title="6.消费者1"></a>6.消费者1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_fanout_email"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_fanout"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//队列声明</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//绑定队列到交换机</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"[1] receive message:"</span>+<span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"[1] over"</span>);</span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="keyword">false</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-消费者2"><a href="#7-消费者2" class="headerlink" title="7.消费者2"></a>7.消费者2</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_fanout_sms"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_fanout"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//队列声明</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//绑定队列到交换机</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"[2] receive message:"</span>+<span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"[2] over"</span>);</span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="keyword">false</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="8-管理界面"><a href="#8-管理界面" class="headerlink" title="8.管理界面"></a>8.管理界面</h4><p><img src="RabbitMQ/fanout_exchange_bind.png" alt=""></p>
<h3 id="9-Routing-direct"><a href="#9-Routing-direct" class="headerlink" title="9.Routing(direct)"></a>9.Routing(direct)</h3><h4 id="1-路由模型"><a href="#1-路由模型" class="headerlink" title="1.路由模型"></a>1.路由模型</h4><p><img src="RabbitMQ/routing.png" alt=""></p>
<h4 id="2-生产者-2"><a href="#2-生产者-2" class="headerlink" title="2.生产者"></a>2.生产者</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="comment">//exchange name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_direct"</span>;</span><br><span class="line">    <span class="comment">//routing key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY = <span class="string">"error"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//获得连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">"direct"</span>);</span><br><span class="line">        <span class="comment">//消息</span></span><br><span class="line">        String message = <span class="string">"hello direct!"</span>+ROUTING_KEY;</span><br><span class="line">        <span class="comment">//发布消息</span></span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME,ROUTING_KEY,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"send message:"</span>+message);</span><br><span class="line">        <span class="comment">//资源释放</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-消费者1-2"><a href="#3-消费者1-2" class="headerlink" title="3.消费者1"></a>3.消费者1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive1</span> </span>&#123;</span><br><span class="line">    <span class="comment">//queue name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_direct_1"</span>;</span><br><span class="line">    <span class="comment">//exchange name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_direct"</span>;</span><br><span class="line">    <span class="comment">//routing key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY = <span class="string">"error"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//获得Connection</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//绑定</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,ROUTING_KEY);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> MyDefaultConsumer(channel,<span class="string">"1"</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="keyword">false</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-消费者2-2"><a href="#4-消费者2-2" class="headerlink" title="4.消费者2"></a>4.消费者2</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive2</span> </span>&#123;</span><br><span class="line">    <span class="comment">//queue name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_direct_2"</span>;</span><br><span class="line">    <span class="comment">//exchange name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_direct"</span>;</span><br><span class="line">    <span class="comment">//routing key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY1 = <span class="string">"info"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY2 = <span class="string">"error"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY3 = <span class="string">"warning"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//获得Connection</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//绑定</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,ROUTING_KEY1);</span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,ROUTING_KEY2);</span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,ROUTING_KEY3);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> MyDefaultConsumer(channel,<span class="string">"2"</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="keyword">false</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>5.MyDefaultConsumer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDefaultConsumer</span> <span class="keyword">extends</span> <span class="title">DefaultConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Channel channel = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">""</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDefaultConsumer</span><span class="params">(Channel channel,String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(channel);</span><br><span class="line">        <span class="keyword">this</span>.channel = channel;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(name+<span class="string">" receive message: "</span>+<span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(name+<span class="string">" over"</span>);</span><br><span class="line">            channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-Exchanges图示"><a href="#5-Exchanges图示" class="headerlink" title="5.Exchanges图示"></a>5.Exchanges图示</h4><p><img src="RabbitMQ/exchanges_direct.png" alt=""></p>
<h3 id="10-Topic-topic"><a href="#10-Topic-topic" class="headerlink" title="10.Topic(topic)"></a>10.Topic(topic)</h3><h4 id="1-模型-3"><a href="#1-模型-3" class="headerlink" title="1.模型"></a>1.模型</h4><p><img src="RabbitMQ/exchange_topic.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.“#”表示0个或若干个关键字，“”表示一个关键字。如“log.”能与“log.warn”匹配，无法与“log.warn.timeout”匹配；但是“log.#”能与上述两者匹配。</span><br><span class="line"></span><br><span class="line">Goods.insert |</span><br><span class="line">Goods.update | ==&gt; Goods.# </span><br><span class="line">Goods.delete |</span><br></pre></td></tr></table></figure>



<h4 id="2-生产者-3"><a href="#2-生产者-3" class="headerlink" title="2.生产者"></a>2.生产者</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_topic"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="comment">//获得连接</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">"topic"</span>);</span><br><span class="line">        String message = <span class="string">"商品。。。"</span>;</span><br><span class="line">        <span class="comment">//发布消息</span></span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME,<span class="string">"goods.delete"</span>,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"topic send message:"</span>+message);</span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-消费者1-3"><a href="#3-消费者1-3" class="headerlink" title="3.消费者1"></a>3.消费者1</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive1</span> </span>&#123;</span><br><span class="line">    <span class="comment">//queue name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_topic_1"</span>;</span><br><span class="line">    <span class="comment">//exchange name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_topic"</span>;</span><br><span class="line">    <span class="comment">//routing key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY = <span class="string">"goods.add"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//获得Connection</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//绑定</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,ROUTING_KEY);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> MyDefaultConsumer(channel,<span class="string">"topic1"</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="keyword">false</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-消费者2-3"><a href="#4-消费者2-3" class="headerlink" title="4.消费者2"></a>4.消费者2</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive2</span> </span>&#123;</span><br><span class="line">    <span class="comment">//queue name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_topic_2"</span>;</span><br><span class="line">    <span class="comment">//exchange name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"test_exchange_topic"</span>;</span><br><span class="line">    <span class="comment">//routing key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY = <span class="string">"goods.#"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//获得Connection</span></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="comment">//创建Channel</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明Queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//绑定</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,ROUTING_KEY);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> MyDefaultConsumer(channel,<span class="string">"topic2"</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="keyword">false</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="11-RabbitMQ的消息确认机制-事务-confirm"><a href="#11-RabbitMQ的消息确认机制-事务-confirm" class="headerlink" title="11.RabbitMQ的消息确认机制(事务+confirm)"></a>11.RabbitMQ的消息确认机制(事务+confirm)</h3><p>在rabbitMQ中 我们可以通过持久化数据，解决rabbitmq服务器异常的数据丢失问题。</p>
<p>问题：生产者将消息发送出来之后，消息到底有没有到RabbitMQ服务器，默认的情况是不知道的。</p>
<p>两种方式：</p>
<p>​    AMQP实现了事务机制</p>
<p>​    Confirm模式</p>
<p>事务机制：</p>
<p>txSelect txCommit txRollback</p>
<p>txSelect:用户将当前channel设置成transaction模式、</p>
<p>txCommit:用于提交事务</p>
<p>txRollback：回滚事务</p>
<h4 id="1事务机制"><a href="#1事务机制" class="headerlink" title="1事务机制"></a>1事务机制</h4><h5 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxSend</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_tx"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        String msgString = <span class="string">"hello tx message!"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"send message:"</span>+msgString);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//开始事务</span></span><br><span class="line">            channel.txSelect();</span><br><span class="line"></span><br><span class="line">            channel.basicPublish(<span class="string">""</span>,QUEUE_NAME,<span class="keyword">null</span>,msgString.getBytes());</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">            channel.txCommit();</span><br><span class="line">            <span class="comment">//事务提交</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//事务回滚</span></span><br><span class="line">            channel.txRollback();</span><br><span class="line">            System.out.println(<span class="string">"send mesage txRollback"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxReceive</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_tx"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//声明queue</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"receive:"</span>+<span class="keyword">new</span> String(body,<span class="string">"utf-8"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="keyword">true</span>,consumer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-Confirm模式"><a href="#2-Confirm模式" class="headerlink" title="2.Confirm模式"></a>2.Confirm模式</h4><h5 id="生产者端confirm模式的实现原理"><a href="#生产者端confirm模式的实现原理" class="headerlink" title="生产者端confirm模式的实现原理"></a>生产者端confirm模式的实现原理</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">生产者将信道设置成confirm模式，一旦信道进入confirm模式，所有在该信道上面发布的消息都会指派成一个唯一的id（从1开</span><br><span class="line">始），一旦消息被投递到所有匹配的队列之后，broker就会发送一个确认给生产者（包含消息的唯一ID），这就使得生产者知道消</span><br><span class="line">息已经正确到达目的队列了，如果消息和队列是可持久化的，那么确认消息会将消息写入磁盘之后发出，broker回传给生产者的确认消息中deliver-tag域包含了确认消息的序列号，此外broker也可以设置basic.ack的multiple域，表示到这个序列号之前的所有消息都已经得到了处理。</span><br></pre></td></tr></table></figure>



<p>Confirm模式最大的好处就在于它是异步的、</p>
<p>Nack；</p>
<p>开启confirm模式。</p>
<p>Channel.confirmSelect();</p>
<p>编程模式：</p>
<p>1.普通 发一条 waitForConfirms()</p>
<p>2.批量 发一批 waitForConfirms()</p>
<p>3.异步 Confirm模式：提供一个回调的方法，</p>
<p>生产者：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_queue_confirm1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生产者调用confirmSelect模式 将channel设置为Confirm模式</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String msgString = <span class="string">"Hello confirm message batch"</span>;</span><br><span class="line">        <span class="comment">//批量发送消息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">""</span>,QUEUE_NAME,<span class="keyword">null</span>,msgString.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//确认</span></span><br><span class="line">        <span class="keyword">if</span>(!channel.waitForConfirms())&#123;</span><br><span class="line">            System.out.println(<span class="string">"message send failed"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"message send ok"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>异步模式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Channel对象提供的confirmListener（）回调方法值包deliveryTag（当前Channel发出的消息序号），我们需要自己为每一个Channel维护一个unconfirm的消息序列集合，每publish一条数据，集合中元素加<span class="number">1</span>.每回到一次handleAck方法，unconfirm集合删除相应的一条（multiple=<span class="keyword">false</span>）或多条（multiple=<span class="keyword">true</span>），从程序的运行效率来看，这个unconfirm集合最好采用有序集合sortedset存储结构。</span><br></pre></td></tr></table></figure>



<h5 id="publish-subscribe和work-queues的区别"><a href="#publish-subscribe和work-queues的区别" class="headerlink" title="publish-subscribe和work queues的区别"></a>publish-subscribe和work queues的区别</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>、publish/subscribe与work queues有什么区别。</span><br><span class="line">区别：</span><br><span class="line"><span class="number">1</span>）work queues不用定义交换机，而publish/subscribe需要定义交换机。</span><br><span class="line"><span class="number">2</span>）publish/subscribe的生产方是面向交换机发送消息，work queues的生产方是面向队列发送消息(底层使用默</span><br><span class="line">	认交换机)。</span><br><span class="line"><span class="number">3</span>）publish/subscribe需要设置队列和交换机的绑定，work queues不需要设置，实质上work queues会将队列绑</span><br><span class="line">定到默认的交换机 。</span><br><span class="line">相同点：</span><br><span class="line">所以两者实现的发布/订阅的效果是一样的，多个消费端监听同一个队列不会重复消费消息。</span><br><span class="line"> </span><br><span class="line"><span class="number">2</span>、实质工作用什么 publish/subscribe还是work queues。</span><br><span class="line">建议使用 publish/subscribe，发布订阅模式比工作队列模式更强大，并且发布订阅模式可以指定自己专用的交换</span><br><span class="line">机。</span><br></pre></td></tr></table></figure>





<p>4.4.4思考<br>1、本案例的需求使用Routing工作模式能否实现？<br>使用Routing模式也可以实现本案例，共设置三个 routingkey，分别是email、sms、all，email队列绑定email和<br>all，sms队列绑定sms和all，这样就可以实现上边案例的功能，实现过程比topics复杂。<br>Topic模式更多加强大，它可以实现Routing、publish/subscirbe模式的功能。</p>
<p>Routing 与 Topic的区别</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">使用Routing模式时，生产者生产信息是带有特殊的rountingKey,一条消息只会发送到一个Queue中，消费者通过唯</span><br><span class="line">一的routingKey来监听指定的Queue</span><br><span class="line"></span><br><span class="line">使用Topic模式时，生产者生产消息时带有通用的routingKey，一条信息可以发送到符合条件的Queue中，消费者通过配置带有#通配符的routingKey来监听满足条件的Queue。</span><br></pre></td></tr></table></figure>



<h4 id="6-headers"><a href="#6-headers" class="headerlink" title="6.headers"></a>6.headers</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">Headers类型的Exchanges是不处理路由键的，而是根据发送的消息内容中的headers属性进行匹配。在绑定Queue与</span><br><span class="line">Exchange时指定一组键值对；当消息发送到RabbitMQ时会取到该消息的headers与Exchange绑定时指定的键值对</span><br><span class="line">进行匹配；如果完全匹配则消息会路由到该队列，否则不会路由到该队列。headers属性是一个键值对，可以是</span><br><span class="line">Hashtable，键值对的值可以是任何类型，而fanout，direct，topic的路由必须都需要字符串形式的。</span><br><span class="line"></span><br><span class="line">匹配规则x-match有下列两种类型：</span><br><span class="line">x-match=all:表示所有的键值对都可匹配才可以接收到消息。</span><br><span class="line">x-match=any:表示只有有键值对匹配就可以接收到到消息。</span><br></pre></td></tr></table></figure>







<p>header模式与routing不同的地方在于，header模式取消routingkey，使用header中的 key/value（键值对）匹配<br>队列。<br>案例：<br>根据用户的通知设置去通知用户，设置接收Email的用户只接收Email，设置接收sms的用户只接收sms，设置两种<br>通知类型都接收的则两种通知都有效。<br>代码：<br>1）生产者<br>队列与交换机绑定的代码与之前不同，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, Object&gt; headers_email = <span class="keyword">new</span> Hashtable&lt;String, Object&gt;();</span><br><span class="line">headers_email.put(<span class="string">"inform_type"</span>, <span class="string">"email"</span>);</span><br><span class="line">Map&lt;String, Object&gt; headers_sms = <span class="keyword">new</span> Hashtable&lt;String, Object&gt;();</span><br><span class="line">headers_sms.put(<span class="string">"inform_type"</span>, <span class="string">"sms"</span>);</span><br><span class="line">channel.queueBind(QUEUE_INFORM_EMAIL,EXCHANGE_HEADERS_INFORM,<span class="string">""</span>,headers_email);</span><br><span class="line">channel.queueBind(QUEUE_INFORM_SMS,EXCHANGE_HEADERS_INFORM,<span class="string">""</span>,headers_sms);</span><br></pre></td></tr></table></figure>





<p>通知：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String message = <span class="string">"email inform to user"</span>+i;</span><br><span class="line">Map&lt;String,Object&gt; headers =  <span class="keyword">new</span> Hashtable&lt;String, Object&gt;();</span><br><span class="line">headers.put(<span class="string">"inform_type"</span>, <span class="string">"email"</span>);<span class="comment">//匹配email通知消费者绑定的header</span></span><br><span class="line"><span class="comment">//headers.put("inform_type", "sms");//匹配sms通知消费者绑定的header</span></span><br><span class="line">AMQP.BasicProperties.Builder properties = <span class="keyword">new</span> AMQP.BasicProperties.Builder();</span><br><span class="line">properties.headers(headers);</span><br><span class="line"><span class="comment">//Email通知</span></span><br><span class="line">channel.basicPublish(EXCHANGE_HEADERS_INFORM, <span class="string">""</span>, properties.build(), message.getBytes());</span><br></pre></td></tr></table></figure>



<p>消费者：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">channel.exchangeDeclare(EXCHANGE_HEADERS_INFORM, BuiltinExchangeType.HEADERS);</span><br><span class="line">Map&lt;String, Object&gt; headers_email = <span class="keyword">new</span> Hashtable&lt;String, Object&gt;();</span><br><span class="line">headers_email.put(<span class="string">"inform_email"</span>, <span class="string">"email"</span>);</span><br><span class="line"><span class="comment">//交换机和队列绑定</span></span><br><span class="line">channel.queueBind(QUEUE_INFORM_EMAIL,EXCHANGE_HEADERS_INFORM,<span class="string">""</span>,headers_email);</span><br><span class="line"><span class="comment">//指定消费队列</span></span><br><span class="line">channel.basicConsume(QUEUE_INFORM_EMAIL, <span class="keyword">true</span>, consumer);</span><br></pre></td></tr></table></figure>



<p>7.RPC</p>
<p>RPC即客户端远程调用服务端的方法 ，使用MQ可以实现RPC的异步调用，基于Direct交换机实现，流程如下：</p>
<ul>
<li>1、客户端即是生产者就是消费者，向RPC请求队列发送RPC调用消息，同时监听RPC响应队列。</li>
<li>2、服务端监听RPC请求队列的消息，收到消息后执行服务端的方法，得到方法返回的结果</li>
<li>3、服务端将RPC方法 的结果发送到RPC响应队列</li>
<li>4、客户端（RPC调用方）监听RPC响应队列，接收到RPC调用结果。</li>
</ul>

        </div>
		
        
        
        
    </div>
</div>








</div>
                




<div class="column is-4-tablet is-3-desktop is-3-widescreen  has-order-1 column-left is-sticky">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/avatar.png" alt="ouYangHao">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        ouYangHao
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        路虽远，行则将至
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>china,shanghai</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            2
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            1
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            1
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">
                关注我</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/ppoffice">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/ppoffice" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">PPOffice</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/rabbitmq/">
            <span class="level-start">
                <span class="level-item">rabbitmq</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/rabbitmq/" style="font-size: 10px;">rabbitmq</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2020/01/18/RabbitMQ/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="RabbitMQ">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-18T08:15:34.000Z">2020-01-18</time></div>
                    <a href="/2020/01/18/RabbitMQ/" class="title has-link-black-ter is-size-6 has-text-weight-normal">RabbitMQ</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/rabbitmq/">rabbitmq</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/01/17/hello-world/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Hello World">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-17T13:22:51.077Z">2020-01-17</time></div>
                    <a href="/2020/01/17/hello-world/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Hello World</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/rabbitmq/">
                        <span class="tag">rabbitmq</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="Hexo" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 ouYang&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                <br>
                <span id="busuanzi_container_site_uv"> 来访 <span id="busuanzi_value_site_uv"></span>人</span>
                <span id="busuanzi_container_site_pv">, 总访问 <span id="busuanzi_value_site_pv"></span>次</span>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'http://yoursite.com',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>